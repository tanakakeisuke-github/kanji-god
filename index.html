<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡å­—ã®ç¥</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Zen+Antique&family=Hachi+Maru+Pop&family=Rampart+One&family=DotGothic16&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background: #f0efec;
  overflow: hidden;
  width: 100vw; height: 100vh;
  font-family: 'M PLUS Rounded 1c', sans-serif;
  user-select: none;
}
canvas { position: fixed; inset: 0; z-index: 0; }

#panel {
  position: fixed; top: 1.2rem; left: 50%;
  transform: translateX(-50%);
  z-index: 20;
  display: flex;
  background: rgba(255,255,255,0.85);
  border-radius: 40px; padding: 5px;
  box-shadow: 0 2px 16px rgba(0,0,0,0.1);
}
.gbtn {
  font-size: 0.75rem; font-weight: 700; letter-spacing: 0.08em;
  padding: 0.45rem 1.3rem; border-radius: 36px; border: none;
  background: transparent; cursor: pointer; transition: all 0.2s;
  color: rgba(0,0,0,0.4);
}
.gbtn.on { color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
#b-en.on  { background: linear-gradient(135deg,#e85d8a,#f7a23e); }
#b-cut.on { background: linear-gradient(135deg,#5b4cff,#a020e0); }
#b-see.on { background: rgba(0,0,0,0.1); color: rgba(0,0,0,0.5); }

#baro {
  position: fixed; top: 1.2rem; left: 1.2rem; z-index: 20;
  width: 175px;
  background: rgba(255,255,255,0.85);
  border-radius: 14px; padding: 1rem 1.1rem;
  box-shadow: 0 2px 14px rgba(0,0,0,0.08);
}
.bt { font-size: 0.52rem; letter-spacing: 0.5em; color: rgba(0,0,0,0.2); margin-bottom: 0.8rem; }
.br { display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.48rem; }
.bl { font-size: 0.58rem; color: rgba(0,0,0,0.4); width: 3.8rem; flex-shrink: 0; }
.btrack { flex:1; height:5px; background:rgba(0,0,0,0.06); border-radius:3px; overflow:hidden; }
.bfill  { height:100%; border-radius:3px; width:0%; transition: width 0.5s ease; }
.bv { font-family:'DotGothic16',monospace; font-size:0.58rem; color:rgba(0,0,0,0.35); width:1.6rem; text-align:right; }
.bdiv { border:none; border-top:1px solid rgba(0,0,0,0.06); margin:0.6rem 0; }
.bbig { display:flex; justify-content:space-around; }
.bbig-n {
  font-family:'Rampart One',sans-serif; font-size:1.75rem; line-height:1; text-align:center;
  background: linear-gradient(135deg,#e85d8a,#f7a23e);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.bbig-l { font-size:0.48rem; color:rgba(0,0,0,0.22); letter-spacing:0.25em; text-align:center; margin-top:2px; }

#elog {
  position: fixed; top: 1.2rem; right: 1.2rem; z-index: 20;
  width: 210px; display: flex; flex-direction: column; gap: 0.28rem;
  pointer-events: none;
}
.eitem {
  font-size: 0.62rem; line-height: 1.55;
  padding: 0.3rem 0.85rem;
  background: rgba(255,255,255,0.85);
  border-radius: 18px; border-left: 3px solid;
  box-shadow: 0 1px 6px rgba(0,0,0,0.05);
  animation: fin 0.3s ease forwards; opacity: 0;
  color: rgba(0,0,0,0.6);
}
@keyframes fin { from{opacity:0;transform:translateX(12px)} to{opacity:1;transform:none} }

#drama {
  position: fixed; inset: 0; z-index: 30;
  pointer-events: none;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; transition: opacity 0.35s;
}
#drama.on { opacity: 1; }
#dtext {
  font-family: 'Zen Antique', serif;
  font-size: clamp(2.5rem,10vw,6rem);
  letter-spacing: 0.4em; color: #1a1a1a;
  text-align: center; line-height: 1.3;
  text-shadow: 0 2px 20px rgba(0,0,0,0.08);
}

.bpop {
  position: fixed; pointer-events: none; z-index: 25;
  font-family: 'Hachi Maru Pop', cursive; font-size: 1.1rem;
  animation: bpop 1.8s ease forwards;
}
@keyframes bpop {
  0%  { opacity:1; transform:translateY(0) scale(0.8); }
  30% { transform:translateY(-24px) scale(1.2); }
  100%{ opacity:0; transform:translateY(-70px) scale(0.9); }
}

#hint {
  position: fixed; bottom: 1.6rem; left: 50%;
  transform: translateX(-50%);
  font-size: 0.56rem; letter-spacing: 0.3em;
  color: rgba(0,0,0,0.18); white-space: nowrap; z-index: 20;
  pointer-events: none;
}

/* ===== ã¤ã¶ã‚„ããƒãƒ–ãƒ« ===== */
.whisper {
  position: fixed;
  pointer-events: none;
  z-index: 15;
  font-family: 'Hachi Maru Pop', 'M PLUS Rounded 1c', cursive, sans-serif;
  font-size: 0.62rem;
  line-height: 1.5;
  color: rgba(30,20,10,0.75);
  background: rgba(255,255,255,0.88);
  border-radius: 12px 12px 12px 2px;
  padding: 0.28rem 0.6rem;
  box-shadow: 0 1px 8px rgba(0,0,0,0.07);
  white-space: nowrap;
  max-width: 140px;
  white-space: normal;
  animation: whisperAnim 3.2s ease forwards;
  transform-origin: bottom left;
}
.whisper::after {
  content: '';
  position: absolute;
  bottom: -5px; left: 8px;
  width: 0; height: 0;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: 6px solid rgba(255,255,255,0.88);
}
@keyframes whisperAnim {
  0%   { opacity:0; transform: scale(0.7) translateY(4px); }
  12%  { opacity:1; transform: scale(1) translateY(0); }
  75%  { opacity:1; transform: translateY(-6px); }
  100% { opacity:0; transform: translateY(-18px); }
}

/* ===== éŸ³æ¥½ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== */
#audio-btn {
  position: fixed; bottom: 1.6rem; right: 1.6rem;
  z-index: 20;
  width: 2.4rem; height: 2.4rem;
  background: rgba(255,255,255,0.82);
  border: none; border-radius: 50%;
  font-size: 1rem; cursor: pointer;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
}
#audio-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.95); }
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="panel">
  <button class="gbtn on" id="b-en"  onclick="setMode('en')">ğŸ’› ç¸çµã³</button>
  <button class="gbtn"    id="b-cut" onclick="setMode('cut')">âœ‚ï¸ å¼•ãé›¢ã—</button>
  <button class="gbtn"    id="b-see" onclick="setMode('see')">ğŸ‘ è¦³å¯Ÿ</button>
</div>

<div id="baro">
  <div class="bt">ECOSYSTEM</div>
  <div class="br"><div class="bl">ğŸ’› ç¸çµã³</div><div class="btrack"><div class="bfill" id="fl-en"   style="background:linear-gradient(90deg,#e85d8a,#f7a23e)"></div></div><div class="bv" id="vl-en">0</div></div>
  <div class="br"><div class="bl">âœ‚ï¸ å¼•ãé›¢ã—</div><div class="btrack"><div class="bfill" id="fl-cut" style="background:linear-gradient(90deg,#5b4cff,#a020e0)"></div></div><div class="bv" id="vl-cut">0</div></div>
  <div class="br"><div class="bl">ğŸŒ¿ å€‹ä½“æ•°</div><div class="btrack"><div class="bfill" id="fl-pop"  style="background:linear-gradient(90deg,#22c55e,#86efac)"></div></div><div class="bv" id="vl-pop">0</div></div>
  <div class="br"><div class="bl">ğŸ’’ æ‹æ„›ä¸­</div><div class="btrack"><div class="bfill" id="fl-love" style="background:linear-gradient(90deg,#f59e0b,#fde68a)"></div></div><div class="bv" id="vl-love">0</div></div>
  <div class="br"><div class="bl">ğŸŒ€ å¤šæ§˜æ€§</div><div class="btrack"><div class="bfill" id="fl-div"  style="background:linear-gradient(90deg,#06b6d4,#a5f3fc)"></div></div><div class="bv" id="vl-div">0</div></div>
  <hr class="bdiv">
  <div class="bbig">
    <div><div class="bbig-n" id="bn-mar">0</div><div class="bbig-l">å©šå§»</div></div>
    <div><div class="bbig-n" id="bn-gen">1</div><div class="bbig-l">ä¸–ä»£</div></div>
    <div><div class="bbig-n" id="bn-birth">0</div><div class="bbig-l">èª•ç”Ÿ</div></div>
  </div>
</div>

<div id="elog"></div>
<div id="drama"><div id="dtext"></div></div>
<button id="audio-btn" onclick="toggleAudio()" title="éŸ³æ¥½ ON/OFF">ğŸ”‡</button>
<div id="hint">ğŸ’›ç¸çµã³ã§ã‚¯ãƒªãƒƒã‚¯ â†’ å‡ºé€¢ã„ã‚’ä½œã‚‹ã€€ï¼ã€€âœ‚ï¸å¼•ãé›¢ã—ã§ã‚¯ãƒªãƒƒã‚¯ â†’ ç¸ã‚’æ–­ã¤ã€€ï¼ã€€SPACEã§å¬å–š</div>

<script>
(function() {
  "use strict";

  // --- Canvas ---
  var canvas = document.getElementById('c');
  var ctx = canvas.getContext('2d');
  var W = canvas.width  = window.innerWidth;
  var H = canvas.height = window.innerHeight;
  window.addEventListener('resize', function() {
    W = canvas.width  = window.innerWidth;
    H = canvas.height = window.innerHeight;
  });

  // --- Groups ---
  var GROUPS = [
    { chars:['æ„›','æ‹','æƒ…','æ…•','çµ†','ç¸'], r:232, g:70,  b:110 },
    { chars:['å…‰','æ˜','è¼','æ™´','æœ—','æš‰'], r:240, g:190, b:10  },
    { chars:['ç”Ÿ','æ´»','è‚²','æ „','ç››','èŒ'], r:34,  g:180, b:60  },
    { chars:['æ°´','æµ','æµ·','æ³³','æ³¢','æ½®'], r:30,  g:140, b:255 },
    { chars:['ç«','ç‚','ç‡ƒ','ç„¦','ç¼','ç†±'], r:255, g:90,  b:20  },
    { chars:['å½±','æš—','éœ§','æ˜','ç„','è”½'], r:130, g:60,  b:230 },
    { chars:['é¢¨','æ°—','é›²','éœ','æ¼‚','çˆ½'], r:0,   g:200, b:200 },
    { chars:['åœŸ','å±±','å²©','åœ°','æ ¹','ç¤'], r:170, g:110, b:40  },
  ];

  var ANCIENT = ['ğ †¢','ğ ‚‰','ğ ‚‡','ğ¡——'];

  var FONTS = [
    "'M PLUS Rounded 1c', sans-serif",
    "'Hachi Maru Pop', cursive",
    "'Zen Antique', serif",
    "'Rampart One', sans-serif",
    "'DotGothic16', monospace",
  ];

  var ATTRACT = {
    0:[1,2,3], 1:[0,2,6], 2:[0,3,7], 3:[2,6,4],
    4:[1,5,7], 5:[4,6,3], 6:[1,3,7], 7:[2,4,5]
  };

  var MERGE = {
    'æ„›æ‹':'è‰¶','æ„›æƒ…':'æ…ˆ','æ„›å…‰':'ç…Œ','æ‹å…‰':'ç‚«','å…‰æ˜':'è¼',
    'ç”Ÿæ°´':'æ³³','ç”Ÿæ´»':'å‘½','æ°´æµ':'æ¼£','ç«ç‚':'ç„”','å½±æ°´':'æ·µ',
    'æ„›ç”Ÿ':'æ…ˆ','å…‰æ°´':'ç€¬','é¢¨æ°´':'æ¶¼','ç«æ°´':'æ¹¯','åœŸæ°´':'æ½¤',
    'æ„›é¢¨':'é¦¨','ç”Ÿé¢¨':'è–«','å…‰åœŸ':'é™½','å½±ç«':'ç‡ƒ','åœŸå±±':'å³°',
    'å…‰ç”Ÿ':'æš‰','æ°´æµ·':'æºŸ','ç«åœŸ':'æº¶','é¢¨æ°—':'æ¼‚',
  };

  // --- ã¤ã¶ã‚„ããƒ‡ãƒ¼ã‚¿ ---
  // ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ãƒ»çŠ¶æ…‹åˆ¥ã®ã¤ã¶ã‚„ã
  var WHISPERS = {
    // æ„›ã‚°ãƒ«ãƒ¼ãƒ—
    'æ„›': { alone:['ã ã‚Œã‹ãã“ã«ã„ã‚‹ï¼Ÿ','ãã¿ã®ã“ã¨ãŒå¿˜ã‚Œã‚‰ã‚Œãªã„','ã©ã“ã«ã„ã‚‹ã®â€¦','ãšã£ã¨ãã°ã«ã„ãŸã„','ä¼šã„ãŸã„ãª'],
            partner:['ã‚‚ã£ã¨è¿‘ãã«æ¥ã¦','ã­ãˆã€æ°—ã¥ã„ã¦ã‚‹ï¼Ÿ','å¿ƒãŒã¯ãšã‚€','ã‚ãªãŸã¨ã„ã‚‹ã¨æ¸©ã‹ã„'],
            repelled:['ã©ã†ã—ã¦â€¦','ã¾ãŸé›¢ã‚Œã¡ã‚ƒã£ãŸ','å¾…ã£ã¦â€¦'] },
    'æ‹': { alone:['ã‚ã®å­ã€ã©ã“è¡Œã£ãŸã‹ãª','èƒ¸ãŒã„ã£ã±ã„','å¥½ãã£ã¦è¨€ãˆãªã„','ã¨ãã‚ããŒæ­¢ã¾ã‚‰ãªã„'],
            partner:['ãšã£ã¨è¦‹ã¦ãŸ','ã‚‚ã—ã‹ã—ã¦ã€ã‚ãŸã—ã®ã“ã¨ï¼Ÿ','ã©ãã©ãã™ã‚‹'],
            repelled:['ãˆã€ãªã‚“ã§ï¼Ÿ','ã‚‚ã†å°‘ã—ã ã£ãŸã®ã«'] },
    'æƒ…': { alone:['ã—ã¿ã˜ã¿ã™ã‚‹ãªã‚','æ¸©ã‚‚ã‚ŠãŒæ¬²ã—ã„','èª°ã‹ãã°ã«ã„ã¦ã»ã—ã„'],
            partner:['ãªã‚“ã‹è½ã¡ç€ã','ã‚ãªãŸã¨ã„ã‚‹ã¨å®‰å¿ƒã™ã‚‹'],
            repelled:['ã¤ã‚‰ã„â€¦'] },
    'æ…•': { alone:['ã‚ã“ãŒã‚Œã‚‹ãªã‚','é ãã‹ã‚‰è¦‹ã¦ã‚‹ã ã‘ã§ã„ã„','å¥½ãã ã‚ˆã€è¨€ãˆãªã„ã‘ã©'],
            partner:['ã†ã‚Œã—ã„ã€æ°—ã¥ã„ã¦ãã‚ŒãŸ'] ,
            repelled:['ã‚„ã£ã±ã‚Šå±Šã‹ãªã‹ã£ãŸã‹'] },
    'çµ†': { alone:['ã¤ãªãŒã‚Šã£ã¦å¤§äº‹ã ã‚ˆãª','ã¿ã‚“ãªã©ã“ã„ã£ãŸ'],
            partner:['ã“ã‚ŒãŒç¸ã¨ã„ã†ã‚„ã¤ã‹'],
            repelled:['çµ†ãŒâ€¦ã»ã©ã‘ãŸ'] },
    'ç¸': { alone:['ä¸æ€è­°ãªå¼•åŠ›ã‚’æ„Ÿã˜ã‚‹','ç³¸ãŒè¦‹ãˆã‚‹æ°—ãŒã™ã‚‹'],
            partner:['ã»ã‚‰ã€ã‚„ã£ã±ã‚Šå¼•ãåˆã£ãŸ'],
            repelled:['ç¸ã¯åˆ‡ã‚Œãªã„ã¯ãšâ€¦'] },
    // å…‰ã‚°ãƒ«ãƒ¼ãƒ—
    'å…‰': { alone:['ã‚‚ã£ã¨è¼ã‘ã‚‹ã¯ãš','ç…§ã‚‰ã—ã¦ã‚ã’ãŸã„èª°ã‹ãŒã„ã‚‹','æ›‡ã‚Šç©ºã¯ã¤ã¾ã‚‰ãªã„'],
            partner:['ãã¿ã‚’ç…§ã‚‰ã—ã¦ã‚ã’ã‚‹','ãµãŸã‚Šã§è¼ã“ã†'],
            repelled:['å…‰ãŒæºã‚Œã¦ã‚‹'] },
    'æ˜': { alone:['å¤œæ˜ã‘ã‚’å¾…ã£ã¦ã‚‹','æ˜ã‚‹ã„å ´æ‰€ã¸è¡Œã“ã†'],
            partner:['ãã¿ã¨ã„ã‚‹ã¨ä¸–ç•ŒãŒæ˜ã‚‹ã„'],
            repelled:['æ€¥ã«æš—ããªã£ãŸæ°—ãŒã™ã‚‹'] },
    'è¼': { alone:['ã‚‚ã£ã¨è¼ããŸã„','è¦‹ã¦ã¦ã€ãœã£ãŸã„å…‰ã‚‹'],
            partner:['ãã¿ã®éš£ã§ã‹ãŒã‚„ã‘ã‚‹'],
            repelled:['ãã™ã‚“ã˜ã‚ƒã£ãŸâ€¦'] },
    'æ™´': { alone:['ä»Šæ—¥ã‚‚ã„ã„å¤©æ°—ï¼','æ°—æŒã¡ã„ã„ãªã‚'],
            partner:['ãµãŸã‚Šã„ã‚Œã°æ™´ã‚Œæ™´ã‚Œã™ã‚‹'],
            repelled:['æ›‡ã£ã¦ããŸâ€¦'] },
    'æœ—': { alone:['ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã„ã“ã†ï¼','ç¬‘ã£ã¦ã‚Œã°ã„ã„ã“ã¨ã‚ã‚‹'],
            partner:['ãã¿ã¨ã„ã‚‹ã¨ç¬‘ãˆã‚‹'],
            repelled:['ã‚ã‚Œã€ãªã‚“ã‹å¯‚ã—ããªã£ãŸ'] },
    'æš‰': { alone:['ã‹ã™ã‹ãªå…‰ã§ã‚‚å±Šã','é ãã¦ã‚‚è¼ã‘ã‚‹'],
            partner:['ã“ã“ã«ã„ã‚‹ã‚ˆ'],
            repelled:['é ããªã£ãŸâ€¦'] },
    // ç”Ÿã‚°ãƒ«ãƒ¼ãƒ—
    'ç”Ÿ': { alone:['ç”Ÿãã¦ã‚‹ã£ã¦ã™ã”ã„','ã‚‚ã£ã¨è‚²ã¡ãŸã„','ã“ã“ã«ã„ã‚‹ãï¼'],
            partner:['ã„ã£ã—ã‚‡ã«è‚²ã¨ã†','ãµãŸã‚Šã§ç”Ÿãã¦ã„ã“ã†'],
            repelled:['ç”Ÿå‘½åŠ›ãŒè½ã¡ãŸæ°—ãŒã™ã‚‹'] },
    'æ´»': { alone:['å…ƒæ°—ã„ã£ã±ã„ï¼','å‹•ãç¶šã‘ã‚‹ã®ãŒå¥½ã','æ­¢ã¾ã‚Œãªã„ï¼'],
            partner:['æ´»åŠ›ãŒå€ã«ãªã£ãŸï¼'],
            repelled:['å‹¢ã„ãŒå‰ŠãŒã‚ŒãŸâ€¦'] },
    'è‚²': { alone:['ã‚‚ã£ã¨å¤§ãããªã‚Œã‚‹','èª°ã‹ã«è‚²ã¦ã¦ã‚‚ã‚‰ã„ãŸã„'],
            partner:['ãã¿ã¨ã„ã‚‹ã¨ä¼¸ã³ã‚‹æ°—ãŒã™ã‚‹'],
            repelled:['æˆé•·ãŒæ­¢ã¾ã‚‹æ°—ãŒã™ã‚‹'] },
    'æ „': { alone:['æ „ãˆã‚‹ã®ãŒå¤¢ã ','ã„ã¤ã‹èŠ±é–‹ã'],
            partner:['ãµãŸã‚Šã§æ „ãˆã‚ˆã†'],
            repelled:['è¡°ãˆãã†â€¦'] },
    'ç››': { alone:['ã‚‚ã£ã¨ç››ã‚Šä¸ŠãŒã‚ã†ãœï¼','ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä½™ã£ã¦ã‚‹'],
            partner:['æœ€é«˜ã«ç››ã‚Šä¸ŠãŒã£ã¦ã‚‹'],
            repelled:['ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ä¸‹ãŒã£ãŸ'] },
    'èŒ': { alone:['ã¡ã£ã¡ã‚ƒã„ã‘ã©ã„ã‚‹ã‚ˆ','æ˜¥ãŒæ¥ãŸæ°—åˆ†','èŠ½å¹ã„ã¦ããŸï¼'],
            partner:['ãã¿ã®ãã°ã§è‚²ã¡ãŸã„'],
            repelled:['éœœãŒé™ã‚ŠãŸæ°—ãŒã™ã‚‹'] },
    // æ°´ã‚°ãƒ«ãƒ¼ãƒ—
    'æ°´': { alone:['ã©ã“ã¸ã§ã‚‚æµã‚Œã¦ã„ã‘ã‚‹','é™ã‹ã§ã„ã„ãª','æµã‚Œã«èº«ã‚’ä»»ã›ã‚ˆã†'],
            partner:['ã„ã£ã—ã‚‡ã«æµã‚Œã‚ˆã†','æº¶ã‘åˆã„ãŸã„'],
            repelled:['æ³¢ç´‹ãŒæ¶ˆãˆãŸâ€¦'] },
    'æµ': { alone:['æµã‚Œã‚’æ„Ÿã˜ã‚‹','ã©ã“ã‹é ãã¸è¡ŒããŸã„'],
            partner:['ä¸€ç·’ã«æµã‚Œã‚‹'],
            repelled:['æµã‚ŒãŒå¤‰ã‚ã£ãŸ'] },
    'æµ·': { alone:['æ·±ã„ãªã‚','åºƒã„ã‚ˆã€ã§ã‚‚å­¤ç‹¬','æ³¢ã®éŸ³ãŒå¥½ã'],
            partner:['åºƒã„æµ·ã‚’ãµãŸã‚Šã§'],
            repelled:['æ½®ãŒå¼•ã„ãŸ'] },
    'æ³³': { alone:['æ³³ãç¶šã‘ã‚‹ã—ã‹ãªã„','ç–²ã‚ŒãŸã‘ã©æ­¢ã¾ã‚Œãªã„'],
            partner:['ãã¿ã¨æ³³ãã®ã¯æ¥½ã—ã„'],
            repelled:['æµã‚Œã«é€†ã‚‰ãˆãªã„'] },
    'æ³¢': { alone:['å¯„ã›ã¦ã¯è¿”ã™â€¦','æ³¢ãŒã‚ã‚‹ã‹ã‚‰é¢ç™½ã„'],
            partner:['æ³¢é•·ãŒåˆã†ï¼'],
            repelled:['æ³¢ãŒãã ã‘ãŸ'] },
    'æ½®': { alone:['å¼•ãæ™‚ã‹ãª','æº€ã¡ã¦ãã¦ã‚‹æ„Ÿã˜ãŒã™ã‚‹'],
            partner:['æ½®ã®æµã‚ŒãŒå¤‰ã‚ã£ãŸæ°—ãŒã™ã‚‹'],
            repelled:['å¼•ãæ½®ã â€¦'] },
    // ç«ã‚°ãƒ«ãƒ¼ãƒ—
    'ç«': { alone:['ç‡ƒãˆã¦ã‚‹ãï¼','èª°ã‹ã‚’æ¸©ã‚ãŸã„','æ¶ˆãˆãŸããªã„ï¼'],
            partner:['ãµãŸã‚Šã§ç‡ƒãˆä¸ŠãŒã‚ã†','ç†±ããªã£ã¦ããŸï¼'],
            repelled:['ç‚ãŒæºã‚Œã¦ã‚‹â€¦'] },
    'ç‚': { alone:['ã¼ãã¯æ¶ˆãˆãªã„','æ¿€ã—ãç‡ƒãˆã‚‹'],
            partner:['ãã¿ã¨ã„ã‚‹ã¨ç‚ãŒå¤§ãããªã‚‹'],
            repelled:['ã¡ã£ã€æ°´ãŒã‹ã‹ã£ãŸ'] },
    'ç‡ƒ': { alone:['ç‡ƒãˆä¸ŠãŒã‚‹æº–å‚™ã¯ã§ãã¦ã‚‹','ç†±ã„ãï¼'],
            partner:['æœ€é«˜æ½®ï¼'],
            repelled:['é®ç«ã—ãŸâ€¦'] },
    'ç„¦': { alone:['ã¡ã‚‡ã£ã¨ç„¦ã£ã¦ã‚‹','ã‚ã›ã‚‹ãªã€ã‚ã›ã‚‹ãª'],
            partner:['è½ã¡ç€ã„ãŸã€‚ãã¿ãŒã„ã‚Œã°'],
            repelled:['ã¾ãŸç„¦ã£ã¦ããŸ'] },
    'ç¼': { alone:['ç„¼ãå°½ãã—ãŸã„è¡å‹•','ç†±ã™ãã‚‹è‡ªåˆ†'],
            partner:['ãã¿ã‚’ç…§ã‚‰ã—ãŸã„'],
            repelled:['é‹­ã„ç—›ã¿'] },
    'ç†±': { alone:['å¸¸ã«ç†±ã„ï¼','å†·ã‚ã‚‹ã®ãŒæ€–ã„'],
            partner:['ç†±é‡ãŒå€ã«ãªã£ãŸ'],
            repelled:['æ€¥ã«å†·ãˆãŸâ€¦'] },
    // å½±ã‚°ãƒ«ãƒ¼ãƒ—
    'å½±': { alone:['èª°ã‚‚è¦‹ã¦ãªã„â€¦','å…‰ã®è£ã«ã„ã¤ã‚‚ã„ã‚‹','é™ã‹ã§ã„ã„'],
            partner:['çã—ã„ã€è¿‘ã¥ã„ã¦ãã‚‹ã‚„ã¤ãŒã„ã‚‹','å…‰ãŒã‚ã‚‹ã‹ã‚‰å½±ãŒã‚ã‚‹'],
            repelled:['ã¾ãŸç‹¬ã‚Šã‹'] },
    'æš—': { alone:['æš—ã„æ–¹ãŒè½ã¡ç€ã','ã²ã¨ã‚Šã§ã„ã„ã€ãŸã¶ã‚“'],
            partner:['â€¦ãªã‚“ã‹å¤‰ãªæ„Ÿã˜ã€æ‚ªããªã„'],
            repelled:['ã‚„ã£ã±ã‚Šæš—é—‡ã«æˆ»ã‚‹'] },
    'éœ§': { alone:['ä½•ã‚‚è¦‹ãˆãªã„','ã¼ã‚“ã‚„ã‚Šã¨ãã“ã«ã„ã‚‹'],
            partner:['éœ§ã®ä¸­ã§ã‚‚ãã¿ãŒè¦‹ãˆã‚‹'],
            repelled:['ã¾ãŸéœ§ã«æ¶ˆãˆãŸ'] },
    'æ˜': { alone:['å¤•æš®ã‚Œã©ããŒå¥½ã','é»„æ˜ã‚Œã¦ã‚‹'],
            partner:['è–„æš®ã®ä¸­ã§å‡ºé€¢ã£ãŸ'],
            repelled:['ã¾ãŸå¤œã«ãªã‚‹'] },
    'ç„': { alone:['æ·±æ·µã‚’è¦—ã„ã¦ã„ã‚‹','è¨€è‘‰ã«ãªã‚‰ãªã„ä½•ã‹'],
            partner:['å¥¥åº•ã§éŸ¿ã'],
            repelled:['é—‡ã«å¸°ã‚‹'] },
    'è”½': { alone:['éš ã‚Œã¦ã„ã‚‹ã®ãŒå®‰å¿ƒ','ãƒ´ã‚§ãƒ¼ãƒ«ã®å‘ã“ã†ã‹ã‚‰è¦‹ã¦ã‚‹'],
            partner:['â€¦è¦‹ãˆã¦ã‚‹ï¼Ÿã“ã“ã«ã„ã‚‹ã‚ˆ'],
            repelled:['ã¾ãŸè¦†ã‚ã‚ŒãŸ'] },
    // é¢¨ã‚°ãƒ«ãƒ¼ãƒ—
    'é¢¨': { alone:['ã©ã“ã«ã§ã‚‚è¡Œã‘ã‚‹','è‡ªç”±ã ï¼','èª°ã‹ã«å±Šã‘ãŸã„ä½•ã‹ãŒã‚ã‚‹'],
            partner:['ã„ã£ã—ã‚‡ã«é£›ã¼ã†','é¢¨ã«ãªã‚Œ'],
            repelled:['å‘ã‹ã„é¢¨ã«ãªã£ãŸ'] },
    'æ°—': { alone:['æ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹','ãªã‚“ã¨ãªãã€ãµã‚ãµã‚'],
            partner:['æ°—ãŒåˆã†ï¼'],
            repelled:['æ°—ãŒæ•£ã£ãŸ'] },
    'é›²': { alone:['ã‚†ã£ãŸã‚Šæµã‚Œã¦ã„ã','å½¢ãŒå¤‰ã‚ã‚Šç¶šã‘ã‚‹'],
            partner:['ãµã‚ã£ã¨åŒ…ã‚“ã§ã‚ã’ãŸã„'],
            repelled:['æ•£ã‚Šæ•£ã‚Šã«ãªã£ãŸ'] },
    'éœ': { alone:['æ˜¥éœã¿ãŸã„ã€ã¯ã‹ãªã„','ã¼ã‚“ã‚„ã‚Šå­˜åœ¨ã—ã¦ã„ã‚‹'],
            partner:['éœã®ä¸­ã§å‡ºé€¢ã£ãŸæ„Ÿã˜'],
            repelled:['æ¶ˆãˆã¦ã„ãâ€¦'] },
    'æ¼‚': { alone:['æ¼‚ã†ã®ãŒå¥½ã','ã©ã“ã§ã‚‚ã„ã„ã€ãŸã æµã‚Œã‚‹'],
            partner:['åŒã˜æ–¹å‘ã«æ¼‚ã£ã¦ã„ã‚‹'],
            repelled:['ã¾ãŸæ¼‚ã„ã¯ã˜ã‚ãŸ'] },
    'çˆ½': { alone:['ãã‚‚ã¡ã„ã„ï¼','æ¸…ã€…ã—ã„æœ','ã•ã£ã±ã‚Šã—ã¦ã‚‹'],
            partner:['ãã¿ã¨ã„ã‚‹ã¨çˆ½å¿«ï¼'],
            repelled:['ã˜ã‚ã£ã¨ã—ãŸâ€¦'] },
    // åœŸã‚°ãƒ«ãƒ¼ãƒ—
    'åœŸ': { alone:['ã©ã£ã—ã‚Šã—ã¦ã‚‹','æ ¹ã‚’å¼µã‚ŠãŸã„','ã“ã“ã‚’é›¢ã‚ŒãŸããªã„'],
            partner:['ãµãŸã‚Šã§ã“ã“ã«æ ¹ã‚’å¼µã‚ã†'],
            repelled:['å¤§åœ°ãŒæºã‚ŒãŸ'] },
    'å±±': { alone:['é«˜ã¿ã‚’ç›®æŒ‡ã—ãŸã„','ã©ã£ã—ã‚Šã¨ã“ã“ã«ã„ã‚‹','å­¤é«˜ã‚‚ã„ã„ãª'],
            partner:['å³°ã§ã¾ãŸé€¢ãŠã†'],
            repelled:['å´©ã‚Œãã†ãªæ„Ÿã˜'] },
    'å²©': { alone:['ã³ãã¨ã‚‚ã—ãªã„','å›ºã„ã®ãŒèª‡ã‚Šã '],
            partner:['ãã¿ã‚‚å›ºã„ã€ã„ã„ãª'],
            repelled:['ã²ã³ãŒå…¥ã£ãŸæ°—ãŒã™ã‚‹'] },
    'åœ°': { alone:['ä¸‡ç‰©ã‚’æ”¯ãˆã¦ã„ã‚‹','ç¸ã®ä¸‹ã®åŠ›æŒã¡'],
            partner:['åœŸå°ã‚’ä¸€ç·’ã«ä½œã‚ã†'],
            repelled:['åœ°ç›¤ãŒæºã‚‰ã„ã '] },
    'æ ¹': { alone:['æ·±ãã€é™ã‹ã«ä¼¸ã³ã¦ã„ã','èª°ã‚‚è¦‹ã¦ãªã„ã‘ã©ã„ã‚‹'],
            partner:['æ ¹ãŒã‹ã‚‰ã¾ã£ã¦ã„ãæ„Ÿã˜'],
            repelled:['æ ¹ãŒåˆ‡ã‚Œãã†'] },
    'ç¤': { alone:['åœŸå°ã§ã‚ã‚‹ã“ã¨ãŒå–œã³','å­˜åœ¨ã™ã‚‹ã“ã¨è‡ªä½“ãŒå½¹å‰²'],
            partner:['ãµãŸã‚Šã§ç¤ã«ãªã‚ã†'],
            repelled:['æºã‚‰ã„ã â€¦'] },
  };

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¤ã¶ã‚„ãï¼ˆè¾æ›¸ã«ãªã„æ–‡å­—ï¼‰
  var WHISPER_DEFAULT = {
    alone:    ['â€¦','ã“ã“ã«ã„ã‚‹','ã©ã“ã¸è¡Œã“ã†','ä¸æ€è­°ãªæ„Ÿã˜','ãµã‚ãµã‚ã™ã‚‹'],
    partner:  ['â€¦ãªã‚“ã‹è¿‘ã„','å¼•ãåˆã†','æ°—ã«ãªã‚‹'],
    repelled: ['ã‚ã€é›¢ã‚ŒãŸ','ã©ã“ã¸â€¦','ã¾ãŸä»Šåº¦'],
  };

  // ã¤ã¶ã‚„ãã‚’å–å¾—
  function getWhisper(char, state) {
    var pool = WHISPERS[char] ? WHISPERS[char][state] : null;
    if (!pool || pool.length === 0) pool = WHISPER_DEFAULT[state];
    return pool[rndInt(pool.length)];
  }

  // DOM ãƒãƒ–ãƒ«ç”Ÿæˆ
  function spawnWhisper(creature) {
    var state = creature.partner ? 'partner' : 'alone';
    if (creature.repelCoolWhisper && creature.repelCoolWhisper > 0) state = 'repelled';
    var text = getWhisper(creature.char, state);
    var d = document.createElement('div');
    d.className = 'whisper';
    d.textContent = text;
    // ã‚­ãƒ£ãƒ©ã®å°‘ã—ä¸Šã«é…ç½®ã€å·¦å³ãƒ©ãƒ³ãƒ€ãƒ ã«ãšã‚‰ã™
    var offsetX = rnd(-20, 20);
    d.style.left = (creature.px - 10 + offsetX) + 'px';
    d.style.top  = (creature.py - creature.sz - 28) + 'px';
    // ã‚°ãƒ«ãƒ¼ãƒ—è‰²ã§ãƒœãƒ¼ãƒ€ãƒ¼
    d.style.borderBottom = '2px solid rgb('+creature.cr+','+creature.cg+','+creature.cb+')';
    document.body.appendChild(d);
    setTimeout(function() { d.remove(); }, 3300);
  }

  // --- State ---
  var creatures  = [];
  var marriages  = 0;
  var births     = 0;
  var maxGen     = 1;
  var cuts       = 0;
  var MAX_POP    = 75;
  var godMode    = 'en';
  var mouseX     = W / 2;
  var mouseY     = H / 2;
  var frame      = 0;
  var lastMarFrame = 0;
  var ripples    = [];
  var particles  = []; // å©šå§»ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  var evLog      = [];
  var dramaTimer = null;

  document.addEventListener('mousemove', function(e) {
    mouseX = e.clientX; mouseY = e.clientY;
  });

  // --- Mode ---
  window.setMode = function(m) {
    godMode = m;
    document.querySelectorAll('.gbtn').forEach(function(b) { b.classList.remove('on'); });
    document.getElementById('b-' + m).classList.add('on');
  };

  // --- Creature ---
  function rnd(a, b) { return a + Math.random() * (b - a); }
  function rndInt(n) { return Math.floor(Math.random() * n); }

  function Creature(opts) {
    opts = opts || {};
    this.gi   = (opts.gi !== undefined) ? opts.gi : rndInt(GROUPS.length);
    var grp   = GROUPS[this.gi];

    if (opts.char) {
      this.char = opts.char;
    } else if (Math.random() < 0.04) {
      this.char = ANCIENT[rndInt(ANCIENT.length)];
    } else {
      this.char = grp.chars[rndInt(grp.chars.length)];
    }

    this.font   = opts.font || FONTS[rndInt(FONTS.length)];
    this.gen    = opts.gen  || 1;
    this.hybrid = !!opts.hybrid;

    this.px = (opts.x !== undefined) ? opts.x : rnd(50, W-50);
    this.py = (opts.y !== undefined) ? opts.y : rnd(50, H-50);
    this.pvx = rnd(-0.7, 0.7);
    this.pvy = rnd(-0.7, 0.7);
    this.maxSpd = rnd(0.45, 1.15);

    if (this.hybrid && opts.pr !== undefined) {
      this.cr = (opts.pr + grp.r) >> 1;
      this.cg = (opts.pg + grp.g) >> 1;
      this.cb = (opts.pb + grp.b) >> 1;
    } else {
      this.cr = grp.r; this.cg = grp.g; this.cb = grp.b;
    }

    this.sz     = opts.sz || rnd(24, 44);
    this.alpha  = 0;
    this.tAlpha = rnd(0.75, 0.95);
    this.age    = 0;
    this.maxAge = rnd(1500, 3500);

    this.wAmp   = rnd(0.25, 0.80);
    this.wFreq  = rnd(0.016, 0.040);
    this.wOff   = rnd(0, Math.PI * 2);
    this.glowPh = rnd(0, Math.PI * 2);
    this.wobble = rnd(0, Math.PI * 2);
    this.wobSpd = rnd(0.015, 0.040);

    this.trail   = [];
    this.partner = null;
    this.married = false;
    this.mCool   = rndInt(120) + 180;

    this.pullX   = 0;
    this.pullY   = 0;
    this.pullStr = 0;

    // ã¤ã¶ã‚„ã
    this.whisperCool = rndInt(200) + 300; // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾…ã¡ãƒãƒƒãƒ•ã‚¡
    this.whisperInterval = rndInt(220) + 180;
    this.repelCoolWhisper = 0;
  }

  Creature.prototype.update = function() {
    this.age++;
    this.glowPh += 0.055;
    this.wobble += this.wobSpd;
    if (this.mCool > 0) this.mCool--;
    if (this.repelCoolWhisper > 0) this.repelCoolWhisper--;

    // ã¤ã¶ã‚„ãã‚¿ã‚¤ãƒãƒ¼
    this.whisperCool--;
    if (this.whisperCool <= 0 && !this.married && this.alpha > 0.5) {
      spawnWhisper(this);
      this.whisperCool = this.whisperInterval + rndInt(120);
    }

    if (this.age < 80) {
      this.alpha = (this.age / 80) * this.tAlpha;
    } else if (this.age > this.maxAge - 80) {
      this.alpha = Math.max(0, (this.maxAge - this.age) / 80 * this.tAlpha);
    } else {
      this.alpha = this.tAlpha;
    }

    var ax = 0, ay = 0;
    for (var i = 0; i < creatures.length; i++) {
      var o = creatures[i];
      if (o === this || o.married) continue;
      var dx = o.px - this.px;
      var dy = o.py - this.py;
      var dist = Math.sqrt(dx*dx + dy*dy) || 1;
      if (dist > 380) continue;
      var ndx = dx / dist, ndy = dy / dist;
      var attList = ATTRACT[this.gi] || [];
      var isAtt  = attList.indexOf(o.gi) >= 0;
      var isSame = o.gi === this.gi;
      if (isAtt && dist < 240) {
        var f = 0.016 * (1 - dist / 240);
        ax += ndx * f; ay += ndy * f;
      } else if (isSame && dist < 70) {
        ax -= ndx * 0.01; ay -= ndy * 0.01;
      }
    }

    if (this.pullStr > 0.005) {
      var pdx = this.pullX - this.px;
      var pdy = this.pullY - this.py;
      var pd  = Math.sqrt(pdx*pdx + pdy*pdy) || 1;
      ax += (pdx / pd) * this.pullStr;
      ay += (pdy / pd) * this.pullStr;
      this.pullStr *= 0.93;
    }

    var spd = Math.sqrt(this.pvx*this.pvx + this.pvy*this.pvy) || 1;
    var perpX = -this.pvy / spd, perpY = this.pvx / spd;
    var wave  = Math.sin(frame * this.wFreq + this.wOff) * this.wAmp;
    this.pvx += ax + perpX * wave * 0.05 + Math.sin(this.wobble) * 0.003;
    this.pvy += ay + perpY * wave * 0.05 + Math.cos(this.wobble * 0.7) * 0.003;

    var s = Math.sqrt(this.pvx*this.pvx + this.pvy*this.pvy) || 1;
    if (s > this.maxSpd) {
      this.pvx = this.pvx / s * this.maxSpd;
      this.pvy = this.pvy / s * this.maxSpd;
    }

    this.px += this.pvx; this.py += this.pvy;

    var margin = 65;
    if (this.px < margin)   this.pvx += 0.06;
    if (this.px > W-margin) this.pvx -= 0.06;
    if (this.py < margin)   this.pvy += 0.06;
    if (this.py > H-margin) this.pvy -= 0.06;

    this.trail.unshift({ x: this.px, y: this.py });
    if (this.trail.length > 12) this.trail.pop();
  };

  Creature.prototype.draw = function() {
    if (this.alpha <= 0) return;

    var glow = 0.45 + 0.55 * Math.sin(this.glowPh);
    var rr = Math.min(255, this.cr + (255 - this.cr) * 0.35 * glow) | 0;
    var gg = Math.min(255, this.cg + (255 - this.cg) * 0.35 * glow) | 0;
    var bb = Math.min(255, this.cb + (255 - this.cb) * 0.35 * glow) | 0;

    // å°¾
    for (var i = 1; i < this.trail.length; i++) {
      var t = this.trail[i], p = this.trail[i-1];
      var ta = (1 - i / this.trail.length) * this.alpha * 0.15;
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
      ctx.lineTo(t.x, t.y);
      ctx.strokeStyle = 'rgba('+rr+','+gg+','+bb+','+ta+')';
      ctx.lineWidth = (this.trail.length - i) / this.trail.length * 3.5;
      ctx.stroke();
    }

    // ã‚°ãƒ­ãƒ¼
    var grad = ctx.createRadialGradient(this.px, this.py, 0, this.px, this.py, this.sz * 2);
    grad.addColorStop(0, 'rgba('+rr+','+gg+','+bb+','+(this.alpha*0.18*glow)+')');
    grad.addColorStop(1, 'rgba('+rr+','+gg+','+bb+',0)');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.arc(this.px, this.py, this.sz * 2, 0, Math.PI * 2);
    ctx.fill();

    // æ–‡å­—
    ctx.save();
    ctx.globalAlpha = this.alpha;
    ctx.font = (this.hybrid ? '900 ' : '') + this.sz + 'px ' + this.font;
    ctx.fillStyle = 'rgb('+rr+','+gg+','+bb+')';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    var ang = Math.atan2(this.pvy, this.pvx) * 0.1;
    ctx.translate(this.px, this.py);
    ctx.rotate(ang);
    if (this.hybrid) {
      ctx.shadowColor = 'rgb('+rr+','+gg+','+bb+')';
      ctx.shadowBlur = 14;
    }
    ctx.fillText(this.char, 0, 0);
    ctx.restore();

    // ç¸ã®ç³¸
    if (this.partner && this.partner.alpha > 0 && !this.married) {
      var ddx = this.partner.px - this.px;
      var ddy = this.partner.py - this.py;
      var dd  = Math.sqrt(ddx*ddx + ddy*ddy);
      if (dd < 260) {
        var pa = (1 - dd/260) * 0.5 * this.alpha;
        ctx.beginPath();
        ctx.moveTo(this.px, this.py);
        ctx.quadraticCurveTo(
          (this.px + this.partner.px)/2 + ddy * 0.2,
          (this.py + this.partner.py)/2 - ddx * 0.2,
          this.partner.px, this.partner.py
        );
        ctx.strokeStyle = 'rgba(230,150,50,' + pa + ')';
        ctx.lineWidth = 1.2;
        ctx.setLineDash([4, 8]);
        ctx.stroke();
        ctx.setLineDash([]);
      }
    }

    // ä¸–ä»£
    if (this.gen > 1) {
      ctx.save();
      ctx.globalAlpha = this.alpha * 0.45;
      ctx.font = '700 8px "M PLUS Rounded 1c", sans-serif';
      ctx.fillStyle = 'rgb('+rr+','+gg+','+bb+')';
      ctx.textAlign = 'center';
      ctx.fillText('G'+this.gen, this.px, this.py + this.sz * 0.72);
      ctx.restore();
    }
  };

  Creature.prototype.isDead = function() {
    return this.age >= this.maxAge;
  };

  // --- Merge ---
  function mergeChar(a, b) {
    if (MERGE[a+b]) return MERGE[a+b];
    if (MERGE[b+a]) return MERGE[b+a];
    var all = [];
    for (var i = 0; i < GROUPS.length; i++) {
      for (var j = 0; j < GROUPS[i].chars.length; j++) all.push(GROUPS[i].chars[j]);
    }
    var unused = all.filter(function(c) {
      return !creatures.some(function(cr) { return cr.char === c; });
    });
    var pool = unused.length > 0 ? unused : all;
    return pool[rndInt(Math.min(8, pool.length))];
  }

  // --- Marriage ---
  function tryMarry(a, b) {
    if (frame - lastMarFrame < 40) return;
    if (a.married || b.married) return;
    if (a.mCool > 0 || b.mCool > 0) return;
    if (a.age < 120 || b.age < 120) return;
    var d = Math.sqrt((a.px-b.px)*(a.px-b.px)+(a.py-b.py)*(a.py-b.py));
    if (d > 30) return;

    a.married = true; b.married = true;
    a.partner = null; b.partner = null;
    marriages++;
    lastMarFrame = frame;

    var nc  = mergeChar(a.char, b.char);
    var ng  = Math.max(a.gen, b.gen) + 1;
    if (ng > maxGen) maxGen = ng;

    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç™ºç«ï¼ˆã»ã‚“ã‚ã‹ï¼‰
    var mx2 = (a.px + b.px) / 2;
    var my2 = (a.py + b.py) / 2;
    spawnMarriageParticles(mx2, my2, a.cr, a.cg, a.cb, b.cr, b.cg, b.cb);
    playMarriageChime(a.cr, a.cg, a.cb);

    showDrama(a.char + ' âˆ ' + b.char, '#1a1a1a', 750, nc);

    setTimeout(function() {
      if (creatures.length < MAX_POP) {
        var gi = Math.random() < 0.5 ? a.gi : b.gi;
        var grp = GROUPS[gi];
        var child = new Creature({
          char: nc, gi: gi,
          font: Math.random() < 0.5 ? a.font : b.font,
          x: (a.px+b.px)/2 + rnd(-18, 18),
          y: (a.py+b.py)/2 + rnd(-18, 18),
          gen: ng, hybrid: true,
          pr: a.cr, pg: a.cg, pb: a.cb,
          sz: rnd(28, 44),
        });
        creatures.push(child);
        births++;
        logEvent(a.char + ' Ã— ' + b.char + ' â†’ ' + nc + 'ã€€G' + ng, '#e85d8a');
        spawnPop(child.px, child.py, nc, child.cr, child.cg, child.cb);
      }
      a.maxAge = a.age + 100;
      b.maxAge = b.age + 100;
    }, 1000);
  }

  // --- Drama ---
  function showDrama(text, color, delay, next) {
    var el = document.getElementById('drama');
    var tx = document.getElementById('dtext');
    tx.style.color = color;
    tx.textContent = text;
    el.classList.add('on');
    clearTimeout(dramaTimer);
    if (next) {
      dramaTimer = setTimeout(function() {
        tx.textContent = next;
        setTimeout(function() { el.classList.remove('on'); }, 700);
      }, delay);
    } else {
      dramaTimer = setTimeout(function() { el.classList.remove('on'); }, delay);
    }
  }

  // --- Birth Popup ---
  function spawnPop(x, y, char, r, g, b) {
    var d = document.createElement('div');
    d.className = 'bpop';
    d.textContent = 'âœ¨' + char;
    d.style.left  = (x - 16) + 'px';
    d.style.top   = (y - 30) + 'px';
    d.style.color = 'rgb('+r+','+g+','+b+')';
    document.body.appendChild(d);
    setTimeout(function() { d.remove(); }, 1800);
  }

  // --- Log ---
  function logEvent(msg, color) {
    color = color || 'rgba(0,0,0,0.6)';
    evLog.unshift({ msg: msg, color: color });
    if (evLog.length > 7) evLog.pop();
    var el = document.getElementById('elog');
    el.innerHTML = '';
    for (var i = 0; i < Math.min(5, evLog.length); i++) {
      var e = evLog[i];
      var d = document.createElement('div');
      d.className = 'eitem';
      d.style.borderColor = e.color;
      d.style.opacity = (1 - i * 0.16).toString();
      d.textContent = e.msg;
      el.appendChild(d);
    }
  }

  // --- Ripple ---
  function addRipple(x, y, r, g, b) {
    ripples.push({ x:x, y:y, rad:0, a:0.7, r:r, g:g, b:b });
  }

  // --- Marriage Particles (ã»ã‚“ã‚ã‹ç‰ˆ) ---
  function spawnMarriageParticles(x, y, r1, g1, b1, r2, g2, b2) {
    // ãµã‚ãµã‚æµ®ã‹ã¶æ·¡ã„ç²’
    var count = 28;
    for (var i = 0; i < count; i++) {
      var angle = Math.random() * Math.PI * 2;
      var speed = 0.2 + Math.random() * 0.9;
      var life  = 90 + Math.random() * 120;
      var size  = 4 + Math.random() * 10;
      // ä¸¡è¦ªã®è‰²ã‚’æ·¡ããƒ‘ã‚¹ãƒ†ãƒ«åŒ–
      var t  = Math.random();
      var br = t < 0.5 ? r1 : r2;
      var bg = t < 0.5 ? g1 : g2;
      var bb2= t < 0.5 ? b1 : b2;
      // ç™½ã«è¿‘ã¥ã‘ã¦ãƒ‘ã‚¹ãƒ†ãƒ«ã«
      br = Math.round(br * 0.45 + 255 * 0.55);
      bg = Math.round(bg * 0.45 + 255 * 0.55);
      bb2= Math.round(bb2* 0.45 + 255 * 0.55);
      particles.push({
        x: x + (Math.random()-0.5)*30,
        y: y + (Math.random()-0.5)*30,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed - 0.3 - Math.random() * 0.5,
        life: life, maxLife: life,
        size: size,
        r: br, g: bg, b: bb2,
        wobble: Math.random() * Math.PI * 2,
        wobSpd: 0.04 + Math.random() * 0.04,
        drift: (Math.random()-0.5) * 0.015,
      });
    }
    // ã‚„ã‚ã‚‰ã‹ã„ãƒªãƒ³ã‚°1ç™ºã ã‘
    addRipple(x, y, (r1+r2)>>1, (g1+g2)>>1, (b1+b2)>>1);
  }

  function drawParticles() {
    for (var i = particles.length - 1; i >= 0; i--) {
      var p = particles[i];
      p.wobble += p.wobSpd;
      p.vx += p.drift + Math.sin(p.wobble) * 0.012;
      p.vy -= 0.012; // ãµã‚ã£ã¨ä¸Šæ˜‡
      p.vx *= 0.992;
      p.vy *= 0.992;
      p.x  += p.vx;
      p.y  += p.vy;
      p.life--;

      if (p.life <= 0) { particles.splice(i, 1); continue; }

      var progress = p.life / p.maxLife; // 1â†’0
      // æœ€åˆã«ãµã‚ã£ã¨ç¾ã‚Œã€æœ€å¾Œã«ãµã‚ã£ã¨æ¶ˆãˆã‚‹
      var alpha = progress < 0.15
        ? (progress / 0.15) * 0.55
        : progress * 0.55;
      var sz = p.size * (0.6 + (1-progress) * 0.5);

      // ã¼ã‚„ã‘ãŸå††ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
      var grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, sz);
      grd.addColorStop(0,   'rgba('+p.r+','+p.g+','+p.b+','+alpha+')');
      grd.addColorStop(0.5, 'rgba('+p.r+','+p.g+','+p.b+','+(alpha*0.5)+')');
      grd.addColorStop(1,   'rgba('+p.r+','+p.g+','+p.b+',0)');
      ctx.fillStyle = grd;
      ctx.beginPath();
      ctx.arc(p.x, p.y, sz, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  function drawRipples() {
    for (var i = ripples.length - 1; i >= 0; i--) {
      var rp = ripples[i];
      ctx.beginPath();
      ctx.arc(rp.x, rp.y, rp.rad, 0, Math.PI * 2);
      ctx.strokeStyle = 'rgba('+rp.r+','+rp.g+','+rp.b+','+rp.a+')';
      ctx.lineWidth = 1.4;
      ctx.stroke();
      rp.rad += 3; rp.a *= 0.964;
      if (rp.a < 0.02) ripples.splice(i, 1);
    }
  }

  // --- Click ---
  canvas.addEventListener('click', function(e) {
    var mx = e.clientX, my = e.clientY;
    var R  = 120;
    var nearby = [];
    for (var i = 0; i < creatures.length; i++) {
      var c = creatures[i];
      if (c.married) continue;
      var d = Math.sqrt((c.px-mx)*(c.px-mx)+(c.py-my)*(c.py-my));
      if (d < R) nearby.push(c);
    }

    if (godMode === 'en') {
      if (nearby.length >= 2) {
        var a = nearby[0], b = nearby[1];
        a.pullX = b.px; a.pullY = b.py; a.pullStr = 0.22;
        b.pullX = a.px; b.pullY = a.py; b.pullStr = 0.22;
        if (!a.partner && !b.partner) { a.partner = b; b.partner = a; }
        logEvent('ç¥ãŒ ' + a.char + ' ã¨ ' + b.char + ' ã®ç¸ã‚’çµã‚“ã ', '#e85d8a');
        addRipple(mx, my, 255, 180, 60);
      } else if (nearby.length === 1) {
        nearby[0].pullX = mx; nearby[0].pullY = my; nearby[0].pullStr = 0.14;
        addRipple(mx, my, 255, 180, 60);
      } else {
        if (creatures.length < MAX_POP) {
          var nc = new Creature({ x: mx + rnd(-20,20), y: my + rnd(-20,20) });
          creatures.push(nc);
          logEvent('ç¥ãŒã€Œ' + nc.char + 'ã€ã‚’å¬å–šã—ãŸ', '#22c55e');
          addRipple(mx, my, 100, 240, 100);
        }
      }
    } else if (godMode === 'cut') {
      cuts++;
      var names = [];
      for (var i = 0; i < nearby.length; i++) {
        var c = nearby[i];
        if (c.partner) { c.partner.partner = null; c.partner.mCool = 300; c.partner.repelCoolWhisper = 90; c.partner.whisperCool = 5; }
        c.partner = null; c.mCool = 300; c.repelCoolWhisper = 90; c.whisperCool = 5;
        var ddx = c.px - mx, ddy = c.py - my;
        var dd  = Math.sqrt(ddx*ddx + ddy*ddy) || 1;
        c.pvx += (ddx/dd) * 1.8 + rnd(-0.5, 0.5);
        c.pvy += (ddy/dd) * 1.8 + rnd(-0.5, 0.5);
        names.push(c.char);
      }
      if (names.length > 0) {
        logEvent('ç¥ãŒç¸ã‚’æ–­ã¡åˆ‡ã£ãŸï¼ˆ' + names.join('ãƒ»') + 'ï¼‰', '#6040ff');
        showDrama('ç¸åˆ‡', 'rgba(80,60,255,0.85)', 700);
      }
      addRipple(mx, my, 100, 80, 255);
    }
  });

  // --- Space ---
  document.addEventListener('keydown', function(e) {
    if (e.code === 'Space' && !e.repeat && creatures.length < MAX_POP) {
      var nc = new Creature({ x: mouseX + rnd(-20,20), y: mouseY + rnd(-20,20) });
      creatures.push(nc);
      logEvent('ã€Œ' + nc.char + 'ã€ãŒç¾ã‚ŒãŸ', '#22c55e');
      e.preventDefault();
    }
  });

  // --- HUD ---
  function updateHUD() {
    var alive = [];
    for (var i = 0; i < creatures.length; i++) {
      if (!creatures[i].married) alive.push(creatures[i]);
    }
    var loving = 0;
    for (var i = 0; i < alive.length; i++) { if (alive[i].partner) loving++; }
    var uniqMap = {};
    for (var i = 0; i < alive.length; i++) uniqMap[alive[i].char] = 1;
    var divCount = Object.keys(uniqMap).length;
    var popLen = alive.length;

    function pct(v, mx) { return Math.min(100, (v/mx)*100) + '%'; }
    document.getElementById('fl-en').style.width   = pct(marriages, 30);
    document.getElementById('vl-en').textContent   = marriages;
    document.getElementById('fl-cut').style.width  = pct(cuts, 20);
    document.getElementById('vl-cut').textContent  = cuts;
    document.getElementById('fl-pop').style.width  = pct(popLen, MAX_POP);
    document.getElementById('vl-pop').textContent  = popLen;
    document.getElementById('fl-love').style.width = pct(loving, popLen || 1);
    document.getElementById('vl-love').textContent = loving;
    document.getElementById('fl-div').style.width  = pct(divCount, 36);
    document.getElementById('vl-div').textContent  = divCount;
    document.getElementById('bn-mar').textContent   = marriages;
    document.getElementById('bn-gen').textContent   = maxGen;
    document.getElementById('bn-birth').textContent = births;
  }

  // --- Maintain ---
  function maintain() {
    var aliveCount = 0;
    for (var i = 0; i < creatures.length; i++) { if (!creatures[i].married) aliveCount++; }
    if (aliveCount < 18 && creatures.length < MAX_POP) {
      var n = Math.min(4, MAX_POP - creatures.length);
      for (var i = 0; i < n; i++) {
        (function(delay) {
          setTimeout(function() { creatures.push(new Creature()); }, delay);
        })(i * 220);
      }
    }
  }

  // --- Draw Background ---
  function drawBG() {
    ctx.fillStyle = '#f0efec';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = 'rgba(0,0,0,0.022)';
    for (var x = 0; x < W; x += 42) {
      for (var y = 0; y < H; y += 42) {
        ctx.fillRect(x, y, 1, 1);
      }
    }
  }

  // --- Initial Spawnï¼ˆãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾Œã«é–‹å§‹ï¼‰---
  function startSpawn() {
    for (var si = 0; si < 40; si++) {
      (function(i) {
        setTimeout(function() { creatures.push(new Creature()); }, i * 85);
      })(si);
    }
  }
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(function() { startSpawn(); });
  } else {
    setTimeout(startSpawn, 1000);
  }

  // --- Loop ---
  function loop() {
    frame++;

    drawBG();
    drawRipples();
    drawParticles();

    // ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼è§£é™¤
    for (var i = 0; i < creatures.length; i++) {
      var c = creatures[i];
      if (c.partner && !c.partner.married) {
        var ddx = c.px - c.partner.px, ddy = c.py - c.partner.py;
        if (Math.sqrt(ddx*ddx+ddy*ddy) > 340) {
          c.partner.partner = null;
          c.partner = null;
          c.mCool = 120;
        }
      }
    }

    // è‡ªå‹•ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å½¢æˆ
    if (frame % 10 === 0) {
      for (var i = 0; i < creatures.length; i++) {
        var a = creatures[i];
        if (a.partner || a.married || a.mCool > 0) continue;
        for (var j = 0; j < creatures.length; j++) {
          var b = creatures[j];
          if (b === a || b.partner || b.married || b.mCool > 0) continue;
          var attList = ATTRACT[a.gi] || [];
          if (attList.indexOf(b.gi) < 0) continue;
          var ddx = a.px-b.px, ddy = a.py-b.py;
          if (Math.sqrt(ddx*ddx+ddy*ddy) < 100) {
            a.partner = b; b.partner = a; break;
          }
        }
      }
    }

    // æ›´æ–°
    for (var i = 0; i < creatures.length; i++) creatures[i].update();

    // æç”»
    creatures.sort(function(a,b) { return a.gen - b.gen; });
    for (var i = 0; i < creatures.length; i++) creatures[i].draw();

    // å©šå§»
    if (frame % 12 === 0) {
      for (var i = 0; i < creatures.length; i++) {
        var a = creatures[i];
        if (a.partner && !a.married) tryMarry(a, a.partner);
      }
    }

    // æ­»äº¡å‰Šé™¤
    var next = [];
    for (var i = 0; i < creatures.length; i++) {
      if (!creatures[i].isDead()) next.push(creatures[i]);
    }
    creatures = next;

    if (frame % 20 === 0) { updateHUD(); maintain(); }

    requestAnimationFrame(loop);
  }

  loop();

  // åˆæœŸãƒ­ã‚°
  setTimeout(function() { logEvent('ç¥ã‚ˆã€æ–‡å­—ã®é‹å‘½ã‚’æ“ã‚Œ', 'rgba(0,0,0,0.45)'); }, 500);
  setTimeout(function() { logEvent('ğŸ’› ç¸çµã³ãƒ¢ãƒ¼ãƒ‰ã§ã‚¯ãƒªãƒƒã‚¯', '#e85d8a'); }, 1400);
  setTimeout(function() { logEvent('âœ‚ï¸ å¼•ãé›¢ã—ãƒ¢ãƒ¼ãƒ‰ã§ã‚¯ãƒªãƒƒã‚¯', '#6040ff'); }, 2500);

  // ============================================================
  // AUDIO ENGINE â€” Web Audio API
  // ============================================================
  var audioCtx = null;
  var audioOn  = false;
  var masterGain = null;
  var scheduledNodes = [];

  // éŸ³éšï¼šæ—¥æœ¬ã®äº”éŸ³éŸ³éšï¼ˆãƒ¨ãƒŠæŠœãé•·éŸ³éšï¼‰D, E, F#, A, B
  var SCALE_HZ = [
    293.66, 329.63, 369.99, 440.00, 493.88,  // D4 E4 F#4 A4 B4
    587.33, 659.25, 739.99, 880.00, 987.77,  // D5 E5 F#5 A5 B5
    146.83, 164.81, 184.99, 220.00, 246.94,  // D3 E3 F#3 A3 B3
  ];

  function initAudio() {
    audioCtx  = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.setValueAtTime(0, audioCtx.currentTime);
    masterGain.gain.linearRampToValueAtTime(0.55, audioCtx.currentTime + 2);
    masterGain.connect(audioCtx.destination);

    startAmbient();
    startMelody();
    startPad();
  }

  // ---- ç’°å¢ƒéŸ³ï¼šæ°´ã®ã‚†ã‚‰ãï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºï¼‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‰ ----
  function startAmbient() {
    var bufSize = audioCtx.sampleRate * 4;
    var buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    var data = buf.getChannelData(0);
    for (var i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1);

    var src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.loop = true;

    var filter = audioCtx.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = 600;
    filter.Q.value = 0.3;

    // LFOã§ã‚†ã‚‰ã
    var lfo = audioCtx.createOscillator();
    var lfoGain = audioCtx.createGain();
    lfo.frequency.value = 0.08;
    lfoGain.gain.value = 200;
    lfo.connect(lfoGain);
    lfo.start();
    lfoGain.connect(filter.frequency);

    var ambGain = audioCtx.createGain();
    ambGain.gain.value = 0.018;

    src.connect(filter);
    filter.connect(ambGain);
    ambGain.connect(masterGain);
    src.start();
    scheduledNodes.push(src, lfo);
  }

  // ---- ç´é¢¨ãƒ¡ãƒ­ãƒ‡ã‚£ï¼šãƒ©ãƒ³ãƒ€ãƒ ã«éŸ³éšã®éŸ³ã‚’ã¯ã˜ã ----
  function pluckNote(freq, time, dur, vol) {
    vol = vol || 0.18;
    // Karplus-Strong é¢¨ï¼šçŸ­ã„ãƒã‚¤ã‚º â†’ ãƒ­ãƒ¼ãƒ‘ã‚¹ â†’ ã‚²ã‚¤ãƒ³
    var osc = audioCtx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = freq;

    // å€éŸ³ã‚’è¶³ã™ï¼ˆä¸‰è§’æ³¢çš„ã«ï¼‰
    var osc2 = audioCtx.createOscillator();
    osc2.type = 'triangle';
    osc2.frequency.value = freq * 2.01;

    var env = audioCtx.createGain();
    env.gain.setValueAtTime(0, time);
    env.gain.linearRampToValueAtTime(vol, time + 0.008);
    env.gain.exponentialRampToValueAtTime(0.001, time + dur);

    var env2 = audioCtx.createGain();
    env2.gain.setValueAtTime(0, time);
    env2.gain.linearRampToValueAtTime(vol * 0.3, time + 0.008);
    env2.gain.exponentialRampToValueAtTime(0.001, time + dur * 0.6);

    osc.connect(env);   env.connect(masterGain);
    osc2.connect(env2); env2.connect(masterGain);
    osc.start(time);  osc.stop(time + dur + 0.1);
    osc2.start(time); osc2.stop(time + dur + 0.1);
  }

  var melodyTimer = null;
  function startMelody() {
    function scheduleNext() {
      if (!audioOn) return;
      var now  = audioCtx.currentTime;
      // ãƒ©ãƒ³ãƒ€ãƒ ã«2ã€œ4éŸ³ã‚’å°‘ã—é–“ã‚’ç½®ã„ã¦é³´ã‚‰ã™
      var notes = 1 + Math.floor(Math.random() * 3);
      var baseT = now + 0.05;
      for (var i = 0; i < notes; i++) {
        var freq = SCALE_HZ[Math.floor(Math.random() * SCALE_HZ.length)];
        var t    = baseT + i * (0.12 + Math.random() * 0.2);
        var dur  = 1.2 + Math.random() * 2.0;
        var vol  = 0.10 + Math.random() * 0.12;
        pluckNote(freq, t, dur, vol);
      }
      // æ¬¡ã®éŸ³ã¾ã§ã®é–“éš”ï¼š0.8ã€œ3.5ç§’
      var interval = 800 + Math.random() * 2700;
      melodyTimer = setTimeout(scheduleNext, interval);
    }
    scheduleNext();
  }

  // ---- ãƒ‘ãƒƒãƒ‰ï¼šä½éŸ³ãƒ‰ãƒ­ãƒ¼ãƒ³ï¼ˆæ¯ã®é•·ã„å’ŒéŸ³ï¼‰ ----
  function startPad() {
    var padFreqs = [146.83, 220.00, 293.66]; // D3, A3, D4
    padFreqs.forEach(function(freq) {
      var osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = freq;

      // ãƒ“ãƒ–ãƒ©ãƒ¼ãƒˆLFO
      var vib = audioCtx.createOscillator();
      var vibG = audioCtx.createGain();
      vib.frequency.value = 0.3 + Math.random() * 0.2;
      vibG.gain.value = freq * 0.003;
      vib.connect(vibG); vibG.connect(osc.frequency);
      vib.start();

      var padGain = audioCtx.createGain();
      padGain.gain.value = 0.022;

      // ã‚†ã£ãã‚Šã¨ã—ãŸãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
      padGain.gain.setValueAtTime(0, audioCtx.currentTime);
      padGain.gain.linearRampToValueAtTime(0.022, audioCtx.currentTime + 5);

      osc.connect(padGain);
      padGain.connect(masterGain);
      osc.start();
      scheduledNodes.push(osc, vib);
    });
  }

  // ---- å©šå§»æ™‚ã®ç‰¹åˆ¥ãªéŸ³ ----
  window.playMarriageChime = function(r1, g1, b1) {
    if (!audioOn || !audioCtx) return;
    // çµå©šã®ç¬é–“ï¼šæ˜ã‚‹ã„ã‚¢ãƒ«ãƒšã‚¸ã‚ª
    var chord = [
      SCALE_HZ[0], SCALE_HZ[2], SCALE_HZ[3], SCALE_HZ[5], SCALE_HZ[7]
    ];
    var now = audioCtx.currentTime;
    chord.forEach(function(freq, i) {
      pluckNote(freq * 2, now + i * 0.1, 2.5, 0.14);
    });
    // é«˜éŸ³ãã‚‰ãã‚‰
    pluckNote(SCALE_HZ[9], now + 0.55, 1.8, 0.10);
    pluckNote(SCALE_HZ[7], now + 0.75, 1.5, 0.08);
  };

  // ---- ON/OFF ----
  window.toggleAudio = function() {
    var btn = document.getElementById('audio-btn');
    if (!audioCtx) {
      initAudio();
      audioOn = true;
      btn.textContent = 'ğŸ””';
      return;
    }
    audioOn = !audioOn;
    if (audioOn) {
      audioCtx.resume();
      masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
      masterGain.gain.linearRampToValueAtTime(0.55, audioCtx.currentTime + 1.0);
      startMelody();
      btn.textContent = 'ğŸ””';
    } else {
      clearTimeout(melodyTimer);
      masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
      masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.0);
      btn.textContent = 'ğŸ”‡';
    }
  };


})();
</script>
</body>
</html>
